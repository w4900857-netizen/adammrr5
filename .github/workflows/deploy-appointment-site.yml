name: Deploy Appointment Booking Site

# Manual trigger only
on:
  workflow_dispatch:

jobs:
  deploy:
    name: Build and Deploy to Render
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: |
          npm install
          echo "âœ… Dependencies installed successfully"
      
      - name: Verify project structure
        run: |
          echo "ðŸ“ Project structure:"
          ls -la
          echo ""
          echo "ðŸ“ Public folder:"
          ls -la public/
      
      # Deploy to Render using their API
      # You need to set these secrets in your GitHub repository settings:
      # - RENDER_API_KEY: Your Render API key (get it from https://dashboard.render.com/account/api-keys)
      # - RENDER_SERVICE_ID: Your Render service ID (get it from your service URL)
      # - TELEGRAM_BOT_TOKEN: Your Telegram bot token
      # - TELEGRAM_CHAT_ID: Your Telegram chat ID
      
      - name: Trigger Render deployment
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          echo "ðŸš€ Triggering deployment to Render..."
          
          # Trigger manual deploy via Render API
          RESPONSE=$(curl -X POST \
            "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": false}')
          
          echo "Response: $RESPONSE"
          
          # Extract deploy ID
          DEPLOY_ID=$(echo $RESPONSE | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)
          echo "Deploy ID: $DEPLOY_ID"
          
          if [ -z "$DEPLOY_ID" ]; then
            echo "âŒ Failed to trigger deployment"
            exit 1
          fi
          
          echo "âœ… Deployment triggered successfully"
          echo "DEPLOY_ID=$DEPLOY_ID" >> $GITHUB_OUTPUT
      
      - name: Wait for deployment
        run: |
          echo "â³ Waiting for deployment to complete (this may take a few minutes)..."
          sleep 120
          echo "âœ… Deployment should be complete now"
      
      - name: Get deployment URL
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          echo "ðŸ” Fetching service information..."
          
          SERVICE_INFO=$(curl -s \
            "https://api.render.com/v1/services/$RENDER_SERVICE_ID" \
            -H "Authorization: Bearer $RENDER_API_KEY")
          
          # Extract service URL
          SERVICE_URL=$(echo $SERVICE_INFO | grep -o '"serviceDetails":{"url":"[^"]*"' | cut -d'"' -f6)
          
          if [ -z "$SERVICE_URL" ]; then
            echo "âš ï¸  Could not extract URL from API response"
            echo "Service info: $SERVICE_INFO"
            SERVICE_URL="https://your-service-name.onrender.com"
          fi
          
          echo ""
          echo "=========================================="
          echo "âœ… DEPLOYMENT SUCCESSFUL!"
          echo "=========================================="
          echo ""
          echo "ðŸŒ Your appointment booking site is now live at:"
          echo "   $SERVICE_URL"
          echo ""
          echo "ðŸ“± Telegram notifications are configured"
          echo "   All new appointments will be sent to your Telegram"
          echo ""
          echo "=========================================="
          echo ""
          echo "DEPLOYED_URL=$SERVICE_URL" >> $GITHUB_OUTPUT
          
          # Set as environment variable for next steps
          echo "DEPLOYED_URL=$SERVICE_URL" >> $GITHUB_ENV
      
      - name: Test deployment
        run: |
          echo "ðŸ§ª Testing deployment..."
          
          # Test health endpoint
          HEALTH_CHECK=$(curl -s -o /dev/null -w "%{http_code}" "${DEPLOYED_URL}/health" || echo "000")
          
          if [ "$HEALTH_CHECK" = "200" ]; then
            echo "âœ… Health check passed!"
          else
            echo "âš ï¸  Health check returned status: $HEALTH_CHECK"
            echo "   The site might still be starting up. Please check manually."
          fi
      
      - name: Deployment summary
        run: |
          echo "## ðŸŽ‰ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Your appointment booking website has been successfully deployed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Website URL" >> $GITHUB_STEP_SUMMARY
          echo "\`${DEPLOYED_URL}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“± Features" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Appointment booking form" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Telegram notifications enabled" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Mobile-friendly design" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Form validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”” Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Visit your website at the URL above" >> $GITHUB_STEP_SUMMARY
          echo "2. Test the booking form" >> $GITHUB_STEP_SUMMARY
          echo "3. Check your Telegram for the notification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Deployed at: $(date)*" >> $GITHUB_STEP_SUMMARY
